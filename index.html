<!DOCTYPE html>
<html lang="en" style="height: 100%; width: 100%;">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>web-paint</title>
</head>
<body style="height: 100%; width: 100%;">
    <style>
        button.tool {
            background-color: #4c5270;
            border: none;
            color: #ffffff;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }

        /* button.tool:hover {
            background-color: #0e86d4;
        } */

        button.activated_tool {
            background-color: #055c9d;
            border: none;
            color: #ffffff;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }

        /* button.activated_tool:hover {
            background-color: #68bbe3;
        } */

        h1 {
            font-size: 24px;
        }

        h2 {
            font-size: 20px;
        }
    </style>

    <div id="tool_bar"></div>

    <div id="tools">
        <div id="colour mixer" hidden>
            <h1>
                colour mixer
            </h1>
            
            <table>
                <tr>
                    <td>
                        red:
                    </td>
                    <td>
                        <div id="colour_red"></div>
                    </td>
                    <td>
                        <input type="range" min="0" max="255" value="0" onchange="colour_mixer.update()" id="input_red" oninput="colour_mixer.update()" onkeypress="colour_mixer.update()">
                    </td>
                    <td id="colour_preview"></td>
                </tr>
                <tr>
                    <td>
                        green:
                    </td>
                    <td>
                        <div id="colour_green"></div>
                    </td>
                    <td>
                        <input type="range" min="0" max="255" value="0" onchange="colour_mixer.update()" id="input_green" oninput="colour_mixer.update()" onkeypress="colour_mixer.update()">
                    </td>
                    <td id="rgb"></td>
                </tr>
                <tr>
                    <td>
                        blue:
                    </td>
                    <td>
                        <div id="colour_blue"></div>
                    </td>
                    <td>
                        <input type="range" min="0" max="255" value="0" onchange="colour_mixer.update()" id="input_blue" oninput="colour_mixer.update()" onkeypress="colour_mixer.update()">
                    </td>
                    <td id="hex"></td>
                </tr>
            </table>

            <hr>
        </div>

        <div id="size" hidden>
            <h1>
                size
            </h1>

            <table>
                <tr>
                    <td>
                        width:
                    </td>
                    <td>
                        <input type="number" id="canvas_w_input" value="50">
                    </td>
                    <td>
                        <button onclick="canvas.change_width()">Apply</button>
                    </td>
                </tr>
                <tr>
                    <td>
                        height:
                    </td>
                    <td>
                        <input type="number" id="canvas_h_input" value="50">
                    </td>
                    <td>
                        <button onclick="canvas.change_height()">Apply</button>
                    </td>
                </tr>
            </table>

            <hr>
        </div>

        <div id="zoom" hidden>
            <h1>
                zoom
            </h1>

            <input type="number" value="10" id="canvas_zoom">
            <button onclick="canvas.change_zoom()">Apply</button>

            <hr>
        </div>

        <div id="background colour" hidden>
            <h1>
                background colour
            </h1>

            <table>
                <tr>
                    <td>
                        rgb
                    </td>
                    <td>
                        hex
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="background_rgb_display"></div>
                    </td>
                    <td>
                        <div id="background_hex_display"></div>
                    </td>
                </tr>
            </table>

            <div>
                <button onclick="canvas.change_colour()">Use from colour mixer</button>
                <br>
                transparent background (only noticable when image is exported):
                <input type="checkbox">
            </div>

            <hr>
        </div>

        <div id="grid settings" hidden>
            <h1>
                grid settings
            </h1>

            show grid:
            <input type="checkbox" id="show_grid" onclick="grid.toggle_grid()" checked="true">
            <br>
            show outer grid:
            <input type="checkbox" id="show_outer_grid" onclick="grid.toggle_outer_grid()" checked="true">
            <br>
            show inner grid:
            <input type="checkbox" id="show_inner_grid" onclick="grid.toggle_inner_grid()" checked="true">
            <br>
            grid thickness (in pixels):
            <input type="number" value="1" id="grid_thickness">
            <button onclick="grid.apply_grid_thickness()">Apply</button>
            <br>
            pixels seperated (width):
            <input type="number" value="10" id="px_sep_w">
            <button onclick="grid.redo_pixels_seperated_w()">Apply</button>
            <br>
            pixels seperated (height):
            <input type="number" value="10" id="px_sep_h">
            <button onclick="grid.redo_pixels_seperated_h()">Apply</button>

            <hr>
        </div>

        <div id="layers" hidden>
            <button onclick="layers.create_layer()">Create new Layer</button>
            <table id="layers_table"></table>
        </div>
    </div>

    <div id="canvas">
        <div id="layer_imgs"></div>

        <div id="grid">
            <div id="inner_grid">
                <div id="horizontal_grid"></div>
                <div id="vertical_grid"></div>
            </div>
        </div>
    </div>

    <div id="outer_grid"></div>

    <script type="text/javascript">
        /**
        white
        #ffffff

        Tiffany Blue
        #bcece0

        Cyan
        #36eee0

        Hot Pink
        #f652a0

        Cornflower
        #4c5270
        */
        
        class Canvas {
            constructor() {
                this.canvas                 = document.getElementById("canvas");
                this.background_rgb_display = document.getElementById("background_rgb_display");
                this.background_hex_display = document.getElementById("background_hex_display");
        
                this.width_input     = document.getElementById("canvas_w_input");
                this.height_input    = document.getElementById("canvas_h_input");
                this.zoom_input      = document.getElementById("canvas_zoom");
        
                this.width      = 50;
                this.height     = 50;
                this.bg_colour  = "#000000";
                this.zoom       = 10;
            }

            change_width() {
                this.width = Number(this.width_input.value);
                change_size();
                this.apply_changes();
                grid.redo_grid();
            }

            change_height() {
                this.height = Number(this.width_input.value);
                change_size();
                this.apply_changes();
                grid.redo_grid();
            }

            change_zoom() {
                this.zoom = Number(this.zoom_input.value);
                this.apply_changes();
                grid.redo_grid();
            }

            change_colour() {
                let r = colour_mixer.rgb_value.textContent;
                let h = colour_mixer.hex_value.textContent;
            
                this.bg_colour = h;
            
                this.background_rgb_display.textContent = r;
                this.background_hex_display.textContent = h;
            
                this.apply_changes();
            }
        
            apply_changes() {
                this.canvas.style = "background-color: " + this.bg_colour + "; height: " + this.height + "px; width: " + this.width + "px; transform: scale(" + this.zoom + "); transform-origin: 0% 0% 0px;";
            }
        }
        
        class Tool {
            constructor() {
                this.tool_bar = document.getElementById("tool_bar");
                this.tools = ["colour mixer", "size", "zoom", "background colour", "grid settings", "layers"];
            }
            
            toggle_tool(to) {
                let e = document.getElementById(to);
                e.hidden = !e.hidden;
            }
        }
        
        class ColourMixer{
            constructor() {
                this.rgb_display = [
                    document.getElementById("colour_red"),
                    document.getElementById("colour_green"),
                    document.getElementById("colour_blue")
                ];
                this.rgb_input = [
                    document.getElementById("input_red"),
                    document.getElementById("input_green"),
                    document.getElementById("input_blue")
                ];
                this.rgb_value      = document.getElementById("rgb");
                this.hex_value      = document.getElementById("hex");
                this.colour_preview = document.getElementById("colour_preview");
            }
        
            component_to_hex(c) {
                // https://www.w3docs.com/snippets/javascript/how-to-convert-rgb-to-hex-and-vice-versa.html
        
                let hex = c.toString(16);
                return hex.length == 1 ? "0" + hex : hex;
            }
        
            update() {
                let r = this.rgb_input[0].value;
                let g = this.rgb_input[1].value;
                let b = this.rgb_input[2].value;
        
                this.rgb_display[0].textContent = r;
                this.rgb_display[1].textContent = g;
                this.rgb_display[2].textContent = b;
        
                this.rgb_value.textContent = "rgb(" + r + ", " + g + ", " + b + ")";
                this.hex_value.textContent = "#" + this.component_to_hex(Number(r)) + this.component_to_hex(Number(g)) + this.component_to_hex(Number(b));
                this.colour_preview.style = "background-color: " + this.hex_value.textContent + ";";
            }
        }
        
        class Grid {
            constructor() {
                this.grid               = document.getElementById("grid");
                this.outer_grid         = document.getElementById("outer_grid");
                this.inner_grid         = document.getElementById("inner_grid");
                this.horizontal_grid    = document.getElementById("horizontal_grid");
                this.vertical_grid      = document.getElementById("vertical_grid");
        
                this.show_grid              = document.getElementById("show_grid");
                this.show_inner_grid        = document.getElementById("show_inner_grid");
                this.show_outer_grid        = document.getElementById("show_outer_grid");
                this.grid_thickness_input   = document.getElementById("grid_thickness");
                this.px_sep_w               = document.getElementById("px_sep_w");
                this.px_sep_h               = document.getElementById("px_sep_h");
        
                this.grid_thickness      = Number(this.grid_thickness_input.value);
                this.horizontal_lines    = [];
                this.vertical_lines      = [];
                this.pixels_seperated_w  = Number(this.px_sep_w.value);
                this.pixels_seperated_h  = Number(this.px_sep_w.value);
            }
        
            toggle_grid() {
                this.grid.hidden = !this.show_grid.checked;
            }
        
            toggle_outer_grid() {
                this.outer_grid.hidden = !this.show_outer_grid.checked;
            }
            
            toggle_inner_grid() {
                this.inner_grid.hidden = !this.show_inner_grid.checked;
            }
        
            remove_horizontal_lines() {
                for (let i = 0; i < this.horizontal_lines.length; i++) {
                    this.horizontal_lines[i].remove();
                }
                this.horizontal_lines = [];
            }
            
            remove_vertical_lines() {
                for (let i = 0; i < this.vertical_lines.length; i++) {
                    this.vertical_lines[i].remove();
                }
                this.vertical_lines = [];
            }
        
            add_horizontal_lines() {
                for (let i = this.pixels_seperated_h * canvas.zoom; i < (canvas.height * canvas.zoom); i = i + this.pixels_seperated_h * canvas.zoom) {
                    console.log(this.grid_thickness);
                    let x = document.createElement("div");
                    x.style = "background-color: #000000; width: " + canvas.width * canvas.zoom + "px; height: " + this.grid_thickness + "px; position: absolute; top: " + i + "px;";
                    this.horizontal_grid.appendChild(x);
                    this.horizontal_lines.push(x);
                }
            }
            
            add_vertical_lines() {
                for (let i = this.pixels_seperated_w * canvas.zoom; i < (canvas.width * canvas.zoom); i = i + this.pixels_seperated_w * canvas.zoom) {
                    let x = document.createElement("div");
                    x.style = "background-color: #000000; height: " + canvas.height * canvas.zoom + "px; width: " + this.grid_thickness + "px; position: absolute; left: " + i + "px;";
                    this.vertical_grid.appendChild(x);
                    this.vertical_lines.push(x);
                }
            }
        
            apply_grid_thickness() {
                this.grid_thickness = Number(this.grid_thickness_input.value);
                this.redo_grid();
            }
            
            redo_pixels_seperated_w() {
                this.pixels_seperated_w = Number(this.px_sep_w.value);
                this.redo_grid();
            }
            
            redo_pixels_seperated_h() {
                this.pixels_seperated_h = Number(this.px_sep_h.value);
                this.redo_grid();
            }
            
            redo_grid() {
                this.remove_horizontal_lines();
                this.remove_vertical_lines();
                this.add_horizontal_lines();
                this.add_vertical_lines();
                this.grid.style = "transform: scale(" + 1 / canvas.zoom + "); transform-origin: 0% 0% 0px;";
            }
        }
        
        class Layer {
            constructor(id) {
                this.pixels = [];
                this.id = id;
                this.layer = document.createElement("div");
                let l = document.getElementById("layer_imgs");

                for (let i = 0; i < canvas.width; i++) {
                    let sublist = [];
                    for (let j = 0; j < canvas.height; j++) {
                        let x = document.createElement("div");
                        x.style = "background-color: #ff0000; height: 1px; width: 1px; position: absolute; top: " + i + "px; left: " + j+ "px;";
                        x.hidden = true;
                        sublist.push(x);
                        this.layer.appendChild(x);
                    }
                    this.pixels.push(sublist);
                }

                l.appendChild(this.layer);
            }
        }

        class Layers {
            constructor() {
                this.layer_gui_table    = document.getElementById("layers_table");
                this.layer_imgs         = document.getElementById("layer_imgs");
        
                this.layer_count    = 0;
                this.layer_table    = [];
                this.layer_objects  = [];
                this.current_layer  = 0;
            }

            create_layer() {
                let l = new Layer(this.layer_count);
                this.layer_objects.push(l);
                let layer_gui = document.createElement("td");

                // layer name
                let layer_name = document.createElement("div");
                let name_input = document.createElement("input");
                name_input.value = "Layer: " + this.layer_count;
                layer_name.appendChild(name_input);
                layer_gui.appendChild(layer_name);

                // hide button
                let toggle_visability = document.createElement("div");
                let visability_text = document.createElement("div");
                visability_text.textContent = "visible: ";
                let visability_checkbox = document.createElement("input");
                visability_checkbox.type = "checkbox";
                visability_checkbox.checked = true;
                visability_checkbox.onclick = () => {
                    l.layer.hidden = !l.layer.hidden;
                };
                toggle_visability.appendChild(visability_text);
                toggle_visability.appendChild(visability_checkbox);
                layer_gui.appendChild(toggle_visability);

                // select button
                let select_button = document.createElement("button");
                select_button.textContent = "Select";
                select_button.onclick = () => {
                    this.layer_table[this.current_layer].style.backgroundColor = "";
                    this.current_layer = l.id;
                    layer_gui.style.backgroundColor = "#f652a0";
                };
                layer_gui.appendChild(select_button);

                // delete button
                let delete_button = document.createElement("button");
                delete_button.textContent = "Delete";
                delete_button.onclick = () => {
                    let x = this.layer_objects[l.id];
                    x.layer.remove()
                    this.layer_objects[l.id] = null;

                    x = this.layer_table[l.id];
                    x.remove();
                    this.layer_table[l.id] = null;

                    if (this.current_layer == l.id) {
                        for (let i = 0; i < this.layer_objects.length; i++) {
                            if (this.layer_objects[i] != null) {
                                this.current_layer = i;
                                this.layer_table[this.current_layer].style.backgroundColor = "#f652a0";
                                return;
                            }
                        }
                        this.current_layer = this.layer_count;
                        this.create_layer();
                    }
                };
                layer_gui.appendChild(delete_button);

                this.layer_table.push(layer_gui);
                this.layer_gui_table.appendChild(layer_gui);

                this.layer_table[this.current_layer].style.backgroundColor = "";
                layer_gui.style.backgroundColor = "#f652a0";
                
                this.current_layer = this.layer_count;
                this.layer_count++;
            }
        }
        
        const canvas = new Canvas();
        const tools  = new Tool();
        const colour_mixer = new ColourMixer();
        const grid = new Grid();
        const layers = new Layers();
        
                // layers
        
                function add_layer() {
                    return;
                    let layer_name_imgs     = "layer_imgs_" + layer_count;
                    let layer_name_table    = "layer_table_" + layer_count;
                    
                    // creating canvas to draw on
                    let x = document.createElement("canvas");   // create a new canvas
                    x.width = canvas_w;                         // set its width
                    x.height = canvas_h;                        // set its height
                    x.id = layer_imgs;                          // add an id
                    LAYER_IMGS.appendChild(x);                  // add it to the others
                    active_ctx = x.getContext("2d");
                    layer_imgs.push(x);
                    // x.style = "-webkit-font-smoothing: antialiased;";
        
                    var size = 200;
                    x.style.width = canvas_w + "px";
                    x.style.height = canvas_h + "px";
        
                    // coloum fot the table
                    x = document.createElement("tr");           // create a new coloum seperator
                    x.id = layer_name_table;                    // give it an id
                    LAYERS_TABLE.appendChild(x);                // add the coloum to the table
                    layer_table.push(x);
        
                    // row for the name
                    let y = document.createElement("td");       // create new row seperator for the layer name
                    y.textContent = "layer " + layer_count;     // give it content
                    x.appendChild(y);                           // add the row to the coloumn
                    
                    // row for toggeling visability 
                    y = document.createElement("td");           // create new row seperator for hiding the layer
                    y.textContent = "visible";                  // add description 
                    let btn = document.createElement("input");  // input for checkbox
                    btn.type = "checkbox";                      // make it to a checkbox
                    y.appendChild(btn);                         // add the button to the row
                    x.appendChild(y);                           // add the row to the coloumn
        
                    layer_count++;
                }
        
                function adapt_layer_sizes() {
                    for (let i = 0; i < layer_imgs.length; i++) {
                        console.log("foo " + i);
                        let x = layer_imgs[i];
                        x.style = "transform: scale(" + 1 / canvas_zoom + "); transform-origin: 0% 0% 0px;";
        
                        active_ctx.scale(canvas_w * canvas_zoom, canvas_h * canvas_zoom);
                        //x.width = canvas_w;
                        //x.height = canvas_h;
                        //x.style.width = canvas_w + "px";
                        //x.style.height = canvas_h + "px";
                    }
                }
        
        // drawing

        function getCursorPosition(canvas, event) {
            const rect = canvas.canvas.getBoundingClientRect();
            let x = (event.clientX - rect.left) / canvas.zoom;
            x = Math.floor(x);
            let y = (event.clientY - rect.top) / canvas.zoom;
            y = Math.floor(y);
            console.log("x: " + x + " y: " + y);

            let layer = layers.layer_objects[layers.current_layer];
            if (!layer.layer.hidden) {
                let pixel = layer.pixels[y][x];
                pixel.style.backgroundColor = colour_mixer.hex_value.textContent;
                pixel.hidden = false;
            }
            
        }

        // universal changes

        function change_size() {

        }
        
            //
            // - setup
            //
        
                function setup() {
                    // colour mixer
                    colour_mixer.update();
        
                    // canvas
                    canvas.change_width();
                    canvas.change_height();
                    canvas.change_zoom();
                    canvas.change_colour();
                    canvas.apply_changes();
                    canvas.canvas.addEventListener('mousedown', function(e) {
                        getCursorPosition(canvas, e)
                    });
        
                    // add tool bar buttons
                    for (let i = 0; i < tools.tools.length; i++) {
                        let t = tools.tools[i];
                        let x = document.createElement("button");
        
                        let f1 = () => {
                            console.log(t);
                            tools.toggle_tool(t);
                            x.className = "activated_tool";
                            x.onclick = f2;
                        }
                        let f2 = () => {
                            console.log(t);
                            tools.toggle_tool(t);
                            x.className = "tool";
                            x.onclick = f1;
                        }
                        x.onclick = f1;
                        x.textContent = t;
                        x.className = "tool";
        
                        tools.tool_bar.appendChild(x);
                    }
        
                    // grid
                    grid.toggle_grid();
                    grid.toggle_inner_grid();
                    grid.toggle_outer_grid();
                    grid.redo_grid();
        
                    // layers
                    layers.create_layer();
                }
                
                setup();
        
        /*
        let canvas = document.getElementById("my_canvas");
        var ctx = canvas.getContext("2d");
        ctx.fillStyle = "#FF0000";
        ctx.fillRect(0, 0, 150, 75);
/*
        console.log(btoa("iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="));
        console.log(atob("iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="));
        // console.log(hex("iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="))

        let x= atob("iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==");
        for (let i = 0; i < x.length; i++) {
            console.log(x.charAt(i));
            console.log(x.charAt(i).charCodeAt(0).toString(16));
            console.log(x.charAt(i).charCodeAt(0));

        }
        var canvas = document.createElement("canvas");


canvas.width = 200;
canvas.height = 200;
/*
canvas

var url = canvas.toDataURL();

var a = document.createElement('a');
a.download = 'my.png';
a.href = url;
a.textContent = 'Download PNG';

let ctx = canvas.getContext('2d');

ctx.fillStyle = '#F0DB4F';
    ctx.strokeStyle = 'red';

    // draw a rectangle with fill and stroke
    ctx.fillRect(50, 50, 150, 100);
    ctx.strokeRect(50, 50, 150, 100);

document.body.appendChild(a);
*/
    </script>
</body>
</html>